# backup

## ДЗ
    Настроить стенд Vagrant с двумя виртуальными машинами: backup_server и client.

    Настроить удаленный бекап каталога /etc c сервера client при помощи borgbackup. Резервные копии должны соответствовать следующим критериям:

        директория для резервных копий /var/backup. Это должна быть отдельная точка монтирования. В данном случае для демонстрации размер не принципиален, достаточно будет и 2GB;
        имя бекапа должно содержать информацию о времени снятия бекапа;
        репозиторий дле резервных копий должен быть зашифрован ключом или паролем - на ваше усмотрение;
        глубина бекапа должна быть год, хранить можно по последней копии на конец месяца, кроме последних трех. Последние три месяца должны содержать копии на каждый день. Т.е. должна быть правильно настроена политика удаления старых бэкапов;
        резервная копия снимается каждые 5 минут. Такой частый запуск в целях демонстрации;
        написан скрипт для снятия резервных копий. Скрипт запускается из соответствующей Cron джобы, либо systemd timer-а - на ваше усмотрение;
        настроено логирование процесса бекапа. Для упрощения можно весь вывод перенаправлять в logger с соответствующим тегом. Если настроите не в syslog, то обязательна ротация логов.

    Запустите стенд на 30 минут. 
    Убедитесь что резервные копии снимаются. 
    Остановите бекап, удалите (или переместите) директорию /etc и восстановите ее из бекапа. 
---
## Выполнение

Запуск стенда   

    vagrant up


Проверка, что служба запускается каждые 5 минут     
![](https://github.com/MaxOOOOON/backup/blob/main/pictures/Screenshot_20211027_220632.png)   

Вывод в лог
![](https://github.com/MaxOOOOON/backup/blob/main/pictures/Screenshot_20211027_235317.png)   


Список копий       

    borg list root@10.0.0.30:/var/backup/etc


Удаление директории и восстановление из бэкапа:      

удаляем etc

    rm -rf /etc

### (ВАЖНО!!!НЕ ИСПОЛЬЗОВАТЬ В ОБЩЕСТВЕННЫХ СЕТЯХ) ps. Признаю, костыль.


Т.к. ssh после удаления etc у нас не работает, то запускаем:       

на клиенте  

    netcat  -l 6666 | tar -xf -

на сервере смотрим список бэкапов

    borg list /var/backup/etc/

затем выполняем 

    borg extract /var/backup/etc::client-2021-10-27T20:15:06

    tar -cf - etc/|nc 10.0.0.31 6666

на клиенте  

    cp -r etc/ /

Клиент  
![](https://github.com/MaxOOOOON/backup/blob/main/pictures/Screenshot_20211027_235142.png) 

Сервер  
![](https://github.com/MaxOOOOON/backup/blob/main/pictures/Screenshot_20211027_235126.png)   
